<!DOCTYPE html>
<html>
<head>
  <title>Drive Picker with CSV Export</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <button id="pickFile">Pick Google Sheet</button>

  <script>
    const CLIENT_ID = "<YOUR_CLIENT_ID>.apps.googleusercontent.com";
    const API_KEY = "<YOUR_API_KEY>";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    let tokenClient;
    let accessToken;

    function initPicker() {
      gapi.load("client:picker", async () => {
        await gapi.client.init({ apiKey: API_KEY });
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (response) => {
            accessToken = response.access_token;
            openPicker();
          }
        });
        tokenClient.requestAccessToken();
      });
    }

    function openPicker() {
      const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
      const picker = new google.picker.PickerBuilder()
        .addView(view)
        .setOAuthToken(accessToken)
        .setDeveloperKey(API_KEY)
        .setCallback(pickerCallback)
        .build();
      picker.setVisible(true);
    }

    async function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const file = data.docs[0];
        console.log("File selected:", file);

        // ✅ Fetch spreadsheet as CSV via Drive API (no Sheets scope required)
        try {
          const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${file.id}/export?mimeType=text/csv`,
            { headers: { Authorization: `Bearer ${accessToken}` } }
          );

          if (!response.ok) throw new Error(`Export failed: ${response.status}`);
          const csvText = await response.text();
          const jsonData = csvToJson(csvText);
          console.log("Parsed JSON:", jsonData);
        } catch (err) {
          console.error("Error fetching/exporting CSV:", err);
        }
      }
    }

    // Simple CSV → JSON parser
    function csvToJson(csv) {
      const lines = csv.split("\n").filter(line => line.trim() !== "");
      const headers = lines[0].split(",").map(h => h.trim());
      return lines.slice(1).map(row => {
        const values = row.split(",");
        return headers.reduce((obj, header, i) => {
          obj[header] = values[i] ? values[i].trim() : "";
          return obj;
        }, {});
      });
    }

    document.getElementById("pickFile").addEventListener("click", initPicker);
  </script>
</body>
</html>